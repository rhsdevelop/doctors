{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block corpo %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Configuração SMTP</h6>
                <button type="button" id="btnTestar" class="btn btn-sm btn-info">
                    <i class="fas fa-sync"></i> Testar Conexão
                </button>
            </div>
            <div class="card-body">
                <form method="post" id="formEmail">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <hr>
                    <button type="submit" class="btn btn-success btn-block">Salvar Configuração</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    document.getElementById('btnTestar').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testando...';
        btn.disabled = true;

        // Captura os valores dos campos do formulário
        const params = new URLSearchParams({
            smtp_server: document.querySelector('[name="smtp_server"]').value,
            smtp_port: document.querySelector('[name="smtp_port"]').value,
            email_user: document.querySelector('[name="email_user"]').value,
            email_password: document.querySelector('[name="email_password"]').value,
            use_tls: document.querySelector('[name="use_tls"]').checked
        });

        fetch(`/config/email/testar/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ ' + data.message);
                } else {
                    alert('❌ ' + data.message);
                }
            })
            .catch(error => alert('Erro ao processar o teste.'))
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    });
</script>
{% endblock %}